##' Plot function for incidence objects
##'
##' This function is used to visualise the output of the \code{\link{incidence}} function, using the
##' package \code{ggplot2}.
##'
##'
##' @export
##'
##' @importFrom graphics plot
##'
##' @author Thibaut Jombart \email{thibautjombart@@gmail.com}
##'
##' @seealso the \code{\link{incidence}} function to generate the 'incidence' objects.
##'
##' @param x An incidence object, generated by the function \code{\link{incidence}}.
##'
##' @param ... Further arguments passed to other methods (currently not used).
##'
##' @param fit an 'incidence.fit' objet as returned by \code{\link{fit}}.
##'
##' @param border The color to be used for the borders of the bars; NA for invisiable borders.
##'
##' @param xlab The label to be used for the x-axis; empty by default.
##'
##' @param ylab The label to be used for the y-axis; by default, a label will be generated
##' automatically according to the time interval used in incidence computation.
##'
##' @examples
##'
##' if(require(outbreaks)) {
##'   onset <- ebola.sim$linelist$date.of.onset
##'
##'   ## daily incidence
##'   inc <- incidence(onset)
##'   inc
##'   plot(inc)
##'
##'   ## weekly incidence
##'   inc.week <- incidence(onset, interval = 7)
##'   inc.week
##'   plot(inc.week)
##'   plot(inc.week, border = "white") # with visible border
##' }
##'
plot.incidence <- function(x, ..., fit = NULL, border = NA, xlab = "", ylab = NULL) {
    df <- as.data.frame(x)

    ## format df if there are groups (otherwise there's just a second column called 'counts')
    if (ncol(df) > 2) {
        n.groups <- ncol(df) - 1
        groups <- factor(rep(names(df)[-1], each = nrow(df)))
        counts <- as.integer(unlist(df[-1]))
        df <- data.frame(dates = df[1], counts = counts, groups = groups)
    }


    ## Use custom labels for usual time intervals
    if (is.null(ylab)) {
        if (x$interval == 1) {
            ylab <- "Daily incidence"
        } else if (x$interval == 7) {
            ylab <- "Weekly incidence"
        } else if (x$interval == 14) {
            ylab <- "Biweekly incidence"
        } else {
            ylab <- sprintf("Incidence by period of %d days", x$interval)
        }
    }

    out <- ggplot2::ggplot(df, ggplot2::aes_string(x = "dates", y = "counts")) +
        ggplot2::geom_bar(stat="identity", width = x$interval, color = border) +
            ggplot2::labs(x = xlab, y = ylab)


    ## Handle fit objects here; 'fit' can be either an 'incidence.fit' object, or a list of
    ## these. In the case of a list, we add geoms one after the other.

    if (!is.null(fit)) {
        if (inherits(fit, "incidence.fit")) {
            out <- add.incidence.fit(out, fit)
        } else if (is.list(fit)) {
            for (i in seq_along(fit)) {
                fit.i <- fit[[i]]
                if (!inherits(fit.i, "incidence.fit")) {
                    stop(sprintf("The %d-th item in 'fit' is not an 'incidence.fit' object, but a %s",
                                 i, class(fit.i)))
                }
                out <- add.incidence.fit(out, fit.i)
            }
        } else {
            stop("fit must be a 'incidence.fit' object, or a list of these")
        }
    }

    out
}




## ##' @export
## plot.incidence_summary <- function(x, ..., ylab = NULL) {
##   if (is.null(ylab)) {
##     ylab <- sprintf("Cases (%d day %s)", x$interval,
##                     if (x$rolling) "rolling average" else "total")
##   }
##   plot.incidence(x, ..., ylab = ylab)
## }
