---
title: "Details of the incidence_fit class"
author: "Zhian N. Kamvar"
date: "`r Sys.Date()`"
output:
   rmarkdown::html_vignette:
     toc: true
     toc_depth: 3
vignette: >
  %\VignetteIndexEntry{Incidence fit class}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>", 
  fig.width=7, 
  fig.height=5, 
  fig.path="figs-fit/"
)
```

This vignette details the structure and construction of the `incidence_fit` and 
`incidence_fit_list` classes, which are produced by the `fit()` and 
`fit_optim_split()` functions, respectively. By the end of this tutorial, you
should be able to construct `incidence_fit` and `incidence_fit_list` objects for
use with your own models.

# Structure of an `incidence_fit` object

An `incidence_fit` object contains three elements:

 - `$lm`: The model fit to an `incidence` object. Currently, this represents a 
    log-linear model, but it can be any model. 
 - `$info`: Information derived from the model
   - `r` The growth rate
   - `r.conf` the confidence interval of `r`
   - `pred` a data frame containing the predictions of the model using the true
      dates (`dates`), their numberic version used in the model (`dates.x`), the
      predicted value (`fit`), and the lower (`lwr`) and upper (`upr`) bounds of
      the associated confidence interval.
   - `doubling` the predicted doubling time in days (only if `r` is positive)
   - `doubling.conf` the confidence interval of the doubling time
   - `halving` the predicted halving time in days (only if `r` is negative)
   - `halving.conf` the confidence interval of the halving time
 - `$origin`: the date corresponding to day '0'

Internally, when `fit()` is run, these elements are constructed by
function `incidence:::extract_info()`. Here, we will show a simplified version 
of the steps `fit()` uses. First we need to setup data. We will use simulated
ebola outbreak data from the *outbreaks* package over weekly intervals

```{r fit_dates}
library(outbreaks)
library(incidence)
dat <- ebola_sim$linelist$date_of_onset
i <- incidence(dat, interval = "week")
i
```

### Step 1: create the model

The default model for `fit()` is a log-linear model on the intervals between 
dates. To fit this model, we will need to create a data frame with the counts
and the midpoints of the intervals:

```{r create_model}
# ensure all dates have at least one incidence
i  <- i[apply(get_counts(i), 1, min) > 0]
df <- as.data.frame(i, long = TRUE)
df$dates.x <- get_dates(i, position = "center", count_days = TRUE)
head(df)
lm1 <- stats::lm(log(counts) ~ dates.x, data = df)
lm1
```

If we compare that to the `$lm` element produced from `fit()`, we can see that
it is identical:

```{r fit_model}
f <- fit(i)
all.equal(f$lm, lm1)
```

### Step 2: creation of the `$info` list:

The `$info` list is created directly from the model itself:

```{r make_info}
r <- stats::coef(lm1)["dates.x"]
r.conf <- stats::confint(lm1, "dates.x", 0.95)
new.data <- data.frame(dates.x = sort(unique(lm1$model$dates.x)))
pred     <- stats::predict(lm1, newdata = new.data, interval = "confidence",
                           level = 0.95)
pred <- cbind.data.frame(new.data, pred)
info_list <- list(
  r = r,
  r.conf = r.conf,
  doubling = log(2)/r,
  doubling.conf = log(2)/r.conf,
  pred = pred
)
info_list
```

### Step 3: combine lists and create object

the last step is to combine everything into a list and create the object.

```{r combine}
the_fit <- list(
  lm = lm1,
  info = info_list,
  origin = min(get_dates(i))
)
class(the_fit) <- "incidence_fit"
the_fit
```

